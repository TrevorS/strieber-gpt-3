# ABOUTME: MCP Server Dockerfile with Node.js - For page_reader (Streamable HTTP)
# Usage: docker build -f Dockerfile.mcp-server-nodejs --build-arg SERVER_MODULE=page_reader -t strieber-mcp-page-reader:latest .
#
# Build arguments:
#   SERVER_MODULE: Python module name to run (page_reader)
#
# This Dockerfile extends the base MCP server setup with Node.js and Mozilla Readability
# for high-quality HTML content extraction.

ARG SERVER_MODULE=page_reader

FROM python:3.11-slim

WORKDIR /app

# Install curl for health checks + Node.js for Mozilla Readability
RUN apt-get update && apt-get install -y \
    curl \
    nodejs \
    npm \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Install Mozilla Readability for better quality extraction than pure-python
RUN npm install -g @mozilla/readability

# Copy all server code files and directories
COPY *.py ./
COPY common ./common/
COPY tests ./tests/

# Note: Some servers (like code-interpreter) need Docker access which requires root or docker group
# For simplicity and security of the code execution sandbox, we run as root
# The real security boundary is the code-executor container, not the MCP server process
RUN useradd -m -u 1000 mcp-user && chown -R mcp-user:mcp-user /app

# Code interpreter needs Docker access, so keep as root for simplicity
# The sandboxing happens in the code-executor container, not this process
# USER mcp-user  # Disabled to allow Docker socket access

# Health checks disabled - servers are stable and working
# Can re-enable with proper /health endpoint if needed

# Run server via launcher.py (handles proper 0.0.0.0 binding for Docker)
ENV PORT=8000
ENV HOST=0.0.0.0
ARG SERVER_MODULE=page_reader
ENV SERVER_MODULE=${SERVER_MODULE}
ENTRYPOINT ["python", "launcher.py"]
