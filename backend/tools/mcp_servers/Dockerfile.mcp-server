# ABOUTME: Generic MCP Server Dockerfile - Parameterized for all MCP servers (Streamable HTTP)
# Usage: docker build -f Dockerfile.mcp-server --build-arg SERVER_MODULE=weather -t strieber-mcp-weather:latest .
#
# Build arguments:
#   SERVER_MODULE: Python module name to run (weather, jina_reader, web_search, code_interpreter)

ARG SERVER_MODULE=weather

FROM python:3.11-slim

WORKDIR /app

# Install curl for health checks + Node.js for Mozilla Readability (page_reader)
RUN apt-get update && apt-get install -y \
    curl \
    nodejs \
    npm \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Install Mozilla Readability for page_reader (better quality extraction than pure-python)
RUN npm install -g @mozilla/readability

# Copy all server code files and directories
COPY *.py ./
COPY common ./common/
COPY tests ./tests/

# Note: Some servers (like code-interpreter) need Docker access which requires root or docker group
# For simplicity and security of the code execution sandbox, we run as root
# The real security boundary is the code-executor container, not the MCP server process
RUN useradd -m -u 1000 mcp-user && chown -R mcp-user:mcp-user /app

# Code interpreter needs Docker access, so keep as root for simplicity
# The sandboxing happens in the code-executor container, not this process
# USER mcp-user  # Disabled to allow Docker socket access

# Health checks disabled - servers are stable and working
# Can re-enable with proper /health endpoint if needed

# Run server via launcher.py (handles proper 0.0.0.0 binding for Docker)
ENV PORT=8000
ENV HOST=0.0.0.0
ARG SERVER_MODULE=weather
ENV SERVER_MODULE=${SERVER_MODULE}
ENTRYPOINT ["python", "launcher.py"]
